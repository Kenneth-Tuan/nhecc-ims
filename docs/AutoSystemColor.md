# 自動化調色

## 🔍 **核心架構設計**

### 1. **環境數據收集層**

```
WeatherAPI Service → 位置服務 → 時間計算 → 數據整合
```

### 2. **顏色生成引擎**

```
環境參數 → 顏色算法 → 主題應用 → UI 更新
```

### 3. **用戶控制層**

```
手動覆蓋 → 自動模式切換 → 偏好設定 → 動畫控制
```

## 📊 **詳細的環境因素量化**

### **時間維度** (精確到小時)

- **05:00-09:00**: 日出時段 (暖橘 → 明黃)
- **09:00-12:00**: 上午 (鮮亮暖色)
- **12:00-15:00**: 中午 (高飽和度)
- **15:00-18:00**: 下午 (漸轉溫暖)
- **18:00-21:00**: 黃昏 (金橙色調)
- **21:00-24:00**: 晚上 (冷藍紫)
- **00:00-05:00**: 深夜 (深藍灰)

### **天氣量化標準**

- **紫外線指數**: 1-2(弱) → 淺藍粉 | 3-5(中) → 明亮 | 6-7(強) → 金黃
- **雲量百分比**: 0-30% → 晴朗 | 30-70% → 多雲 | 70-100% → 陰沉
- **降雨量**: <1mm → 小雨(淺藍) | 1-5mm → 中雨(深藍) | >5mm → 大雨(墨藍)

### **溫度量化** (℃)

- **<10°**: 冰冷 (藍紫灰)
- **10-20°**: 涼爽 (藍綠)
- **20-25°**: 舒適 (自然色)
- **25-30°**: 溫暖 (黃橙)
- **>30°**: 炎熱 (紅橙)

## 🛠 **技術實現細節**

### **API 整合策略**

```typescript
interface WeatherData {
  temperature: number;
  weather: "sunny" | "cloudy" | "rainy";
  uvIndex: number;
  cloudCover: number;
  precipitation: number;
  location: { lat: number; lng: number };
}
```

### **顏色生成算法**

```typescript
// HSL 顏色空間運算
function generateAdaptiveColor(
  envData: WeatherData,
  timeOfDay: TimeSlot
): HSLColor {
  const baseHue = calculateBaseHue(envData, timeOfDay);
  const saturation = calculateSaturation(envData);
  const lightness = calculateLightness(envData, timeOfDay);

  return { h: baseHue, s: saturation, l: lightness };
}
```

### **動態主題應用**

- **平滑過渡**: 500ms CSS transition
- **性能優化**: 防抖更新 (5 分鐘間隔)
- **記憶體管理**: 智能緩存策略

## 🎛 **用戶體驗設計**

### **控制面板**

1. **自動模式開關**
2. **環境因素權重滑桿** (時間:70%, 天氣:20%, 溫度:10%)
3. **顏色強度調整** (溫和/適中/強烈)
4. **過渡速度設定**
5. **地理位置設定** (手動/自動)

### **備用機制**

- **離線模式**: 使用最後的環境數據
- **靜態備用**: 預設美觀主題
- **手動覆蓋**: 用戶可隨時調整

## 🔧 **實現優先級**

### **Phase 1: 基礎框架**

- 時間基於的自動調色 ✅
- 用戶手動選擇介面 ✅ (已有實現)

### **Phase 2: 天氣整合**

- 天氣 API 整合
- 基本天氣顏色映射
- 地理位置獲取

### **Phase 3: 進階優化**

- 多因素綜合計算
- 動畫過渡效果
- 用戶偏好學習
- 性能優化

### **Phase 4: 智慧功能**

- 機器學習顏色偏好
- 場景預測
- 跨設備同步

---

## 📡 **氣象 API Response 欄位說明**

### **API Response 結構**

```typescript
interface WeatherStationResponse {
  StationName: string; // 測站名稱 (例: "臺中")
  StationId: string; // 測站代碼 (例: "467490")

  ObsTime: {
    // 觀測時間
    DateTime: string; // ISO 8601 格式時間 (例: "2025-11-14T09:20:00+08:00")
  };

  GeoInfo: {
    // 地理資訊
    Coordinates: Array<{
      // 座標系統陣列
      CoordinateName: string; // 座標系統名稱 (例: "TWD67", "WGS84")
      CoordinateFormat: string; // 座標格式 (例: "decimal degrees")
      StationLatitude: string; // 測站緯度 (度)
      StationLongitude: string; // 測站經度 (度)
    }>;
    StationAltitude: string; // 測站海拔高度 (公尺)
    CountyName: string; // 縣市名稱 (例: "臺中市")
    TownName: string; // 鄉鎮市區名稱 (例: "北區")
    CountyCode: string; // 縣市代碼 (例: "66000")
    TownCode: string; // 鄉鎮市區代碼 (例: "66000050")
  };

  WeatherElement: {
    // 天氣要素
    Weather: string; // 天氣現象描述 (雲量+天氣現象，詳見天氣現象描述表)

    VisibilityDescription: string; // 能見度描述 (特定字串｜>30｜-99:表示缺值或資料異常)

    SunshineDuration: string; // 日照時數 (小時｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)

    Now: {
      // 即時觀測值
      Precipitation: string; // 現在降雨量 (毫米｜小數點下1位｜X：表示儀器故障；T：表示雨跡？？？；-99:表示缺值或資料異常；-98:表示連續6小時無降水)
    };

    WindDirection: string; // 風向 (度｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常；990:表示風向不定）

    WindSpeed: string; // 風速 (公尺/秒｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)

    AirTemperature: string; // 氣溫 (攝氏度｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)

    RelativeHumidity: string; // 相對濕度 (百分比｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)

    AirPressure: string; // 氣壓 (百帕｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)

    UVIndex: string; // 紫外線指數 (UVI｜整數值｜X：表示儀器故障；-99:表示缺值或資料異常)

    Max10MinAverage: {
      // 過去10分鐘最大平均值
      WindSpeed: string; // 最大平均風速 (公尺/秒｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)
      Occurred_at: {
        // 發生時間
        WindDirection: string; // 發生時的風向 (度｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常；990:表示風向不定)
        DateTime: string; // 發生時間 (ISO 8601)
      };
    };

    GustInfo: {
      // 陣風資訊
      PeakGustSpeed: string; // 最大陣風風速 (公尺/秒｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)
      Occurred_at: {
        // 發生時間
        WindDirection: string; // 發生時的風向 (度｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常；990:表示風向不定)
        DateTime: string; // 發生時間 (ISO 8601)
      };
    };

    DailyExtreme: {
      // 日極值
      DailyHigh: {
        // 日最高值
        TemperatureInfo: {
          // 溫度資訊
          AirTemperature: string; // 最高氣溫 (攝氏度｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)
          Occurred_at: {
            // 發生時間
            DateTime: string; // 發生時間 (ISO 8601)
          };
        };
      };
      DailyLow: {
        // 日最低值
        TemperatureInfo: {
          // 溫度資訊
          AirTemperature: string; // 最低氣溫 (攝氏度｜至小數點下1位｜X：表示儀器故障；-99:表示缺值或資料異常)
          Occurred_at: {
            // 發生時間
            DateTime: string; // 發生時間 (ISO 8601)
          };
        };
      };
    };
  };
}
```

### **欄位標準對照表**

| 欄位名稱                   | 單位/格式              | 說明                                  | 特殊值                                                                          | 用於調色系統                                                          |
| -------------------------- | ---------------------- | ------------------------------------- | ------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| `Weather`                  | 字串                   | 天氣現象描述 (例: "晴", "多雲", "雨") | -                                                                               | ✅ 主要天氣判斷依據                                                   |
| `UVIndex`                  | UVI (整數值)           | 紫外線指數                            | `X`: 儀器故障<br>`-99`: 缺值或資料異常                                          | ✅ 晴天強度判斷 (1-2 弱, 3-5 中, 6-7 強)                              |
| `AirTemperature`           | ℃ (至小數點下 1 位)    | 氣溫                                  | `X`: 儀器故障<br>`-99`: 缺值或資料異常                                          | ✅ 溫度顏色映射 (<10° 冷, 10-20° 涼, 20-25° 舒適, 25-30° 暖, >30° 熱) |
| `Precipitation`            | mm (至小數點下 1 位)   | 現在降雨量                            | `X`: 儀器故障<br>`T`: 雨跡<br>`-99`: 缺值或資料異常<br>`-98`: 連續 6 小時無降水 | ✅ 雨天強度判斷 (<1mm 小雨, 1-5mm 中雨, >5mm 大雨)                    |
| `ObsTime.DateTime`         | ISO 8601               | 觀測時間                              | -                                                                               | ✅ 時間維度判斷 (上午/下午/晚上)                                      |
| `SunshineDuration`         | 小時 (至小數點下 1 位) | 日照時數                              | `X`: 儀器故障<br>`-99`: 缺值或資料異常                                          | ⚠️ 可選：輔助判斷雲量                                                 |
| `RelativeHumidity`         | % (至小數點下 1 位)    | 相對濕度                              | `X`: 儀器故障<br>`-99`: 缺值或資料異常                                          | ⚠️ 可選：影響顏色飽和度                                               |
| `WindSpeed`                | m/s (至小數點下 1 位)  | 風速                                  | `X`: 儀器故障<br>`-99`: 缺值或資料異常                                          | ⚠️ 可選：影響動態效果                                                 |
| `WindDirection`            | 度 (至小數點下 1 位)   | 風向 (0-360)                          | `X`: 儀器故障<br>`-99`: 缺值或資料異常<br>`990`: 風向不定                       | ⚠️ 可選：不直接影響顏色                                               |
| `VisibilityDescription`    | 特定字串               | 能見度描述                            | `>30`: 大於 30 公里<br>`-99`: 缺值或資料異常                                    | ⚠️ 可選：輔助判斷天氣狀況                                             |
| `AirPressure`              | 百帕 (至小數點下 1 位) | 氣壓                                  | `X`: 儀器故障<br>`-99`: 缺值或資料異常                                          | ⚠️ 可選：不直接影響顏色                                               |
| `GeoInfo.StationLatitude`  | 度                     | 緯度                                  | -                                                                               | ⚠️ 可選：季節性調整                                                   |
| `GeoInfo.StationLongitude` | 度                     | 經度                                  | -                                                                               | ⚠️ 可選：時區計算                                                     |

### 天氣現象描述表

#### 雲量
三種型態
1. 晴
2. 多雲
3. 陰

#### 天氣現象
20種型態
1. -
2. 有霾
3. 有靄
4. 有閃電
5. 有雷聲
6. 有霧
7. 有雨
8. 有雨雪
9. 有大雪
10. 有雪珠
11. 有冰珠
12. 有陣雨
13. 陣雨雪
14. 有雹
15. 有雷雨
16. 有雷雪
17. 有雷雹
18. 大雷雨
19. 大雷雹
20. 有雷

### **特殊值說明**

#### **通用特殊值**

- **`X`**: 表示儀器故障，無法取得觀測資料
- **`-99`**: 表示缺值或資料異常，無法使用該資料
- **`-98`**: (僅 `Precipitation`) 表示連續 6 小時無降水

#### **欄位特定特殊值**

- **`Precipitation = "T"`**: 表示雨跡（微量降雨，不足以測量）
- **`WindDirection = "990"`**: 表示風向不定（無法判斷風向）
- **`VisibilityDescription = ">30"`**: 表示能見度大於 30 公里（極佳能見度）

#### **座標系統**

- **`TWD67`**: 台灣地區座標系統 (舊系統)
- **`WGS84`**: 世界大地測量系統 (國際標準)

### **用於自動調色的關鍵欄位**

#### **主要欄位** (必須)

1. **時間**: `ObsTime.DateTime`

   - 用途：判斷時段 (05:00-09:00 日出, 09:00-12:00 上午, 12:00-15:00 中午, 15:00-18:00 下午, 18:00-21:00 黃昏, 21:00-24:00 晚上, 00:00-05:00 深夜)
   - 權重：高 (70%)

2. **天氣**: `Weather`

   - 用途：基本天氣類型判斷 (晴/多雲/陰/雨)
   - 權重：高 (20%)

3. **紫外線**: `UVIndex`

   - 用途：晴天強度判斷 (1-2 弱, 3-5 中, 6-7 強, 8+極強)
   - 權重：中 (10%)
   - 注意：需檢查特殊值 (`X`, `-99`)

4. **降雨**: `Precipitation`

   - 用途：雨天強度判斷 (<1mm 小雨, 1-5mm 中雨, >5mm 大雨)
   - 權重：中 (10%)
   - 注意：需檢查特殊值 (`X`, `T`, `-99`, `-98`)

5. **溫度**: `AirTemperature`
   - 用途：溫度顏色映射 (<10° 冷, 10-20° 涼, 20-25° 舒適, 25-30° 暖, >30° 熱)
   - 權重：中 (10%)
   - 注意：需檢查特殊值 (`X`, `-99`)

#### **輔助欄位** (可選)

- `SunshineDuration`: 輔助判斷雲量
- `RelativeHumidity`: 影響顏色飽和度
- `WindSpeed`: 影響動態效果（未來擴展）

---

## 🎨 **欄位數值對應顏色表**

### **1. 時間維度顏色映射**

| 時段 | 時間範圍    | HSL 色相 (H) | 飽和度 (S) | 明度 (L) | 顏色描述    | 範例顏色          |
| ---- | ----------- | ------------ | ---------- | -------- | ----------- | ----------------- |
| 日出 | 05:00-09:00 | 15-30°       | 60-80%     | 50-70%   | 暖橘 → 明黃 | #FF8C42 → #FFD700 |
| 上午 | 09:00-12:00 | 30-50°       | 70-90%     | 60-80%   | 鮮亮暖色    | #FFB84D → #FFE066 |
| 中午 | 12:00-15:00 | 40-60°       | 80-100%    | 70-90%   | 高飽和度    | #FFD700 → #FFEB3B |
| 下午 | 15:00-18:00 | 20-40°       | 60-80%     | 55-75%   | 漸轉溫暖    | #FFA500 → #FFB84D |
| 黃昏 | 18:00-21:00 | 10-25°       | 70-90%     | 45-65%   | 金橙色調    | #FF6B35 → #FF8C42 |
| 晚上 | 21:00-24:00 | 220-260°     | 40-60%     | 30-50%   | 冷藍紫      | #4A5568 → #718096 |
| 深夜 | 00:00-05:00 | 240-270°     | 30-50%     | 20-40%   | 深藍灰      | #2D3748 → #4A5568 |

### **2. 天氣類型顏色映射**

| 天氣類型 | Weather 值 | HSL 色相 (H) | 飽和度 (S) | 明度 (L) | 顏色描述 | 範例顏色          |
| -------- | ---------- | ------------ | ---------- | -------- | -------- | ----------------- |
| 晴天     | "晴"       | 30-60°       | 70-90%     | 60-80%   | 明亮暖色 | #FFD700 → #FFEB3B |
| 多雲     | "多雲"     | 180-220°     | 40-60%     | 50-70%   | 柔和藍灰 | #87CEEB → #B0C4DE |
| 陰天     | "陰"       | 200-240°     | 30-50%     | 40-60%   | 沉穩灰藍 | #708090 → #778899 |
| 雨天     | "雨"       | 200-240°     | 50-70%     | 30-50%   | 深藍灰   | #4682B4 → #5F9EA0 |

### **3. 紫外線指數顏色映射**

| UV 指數 | 強度等級 | HSL 色相 (H) | 飽和度 (S) | 明度 (L) | 顏色描述   | 範例顏色          |
| ------- | -------- | ------------ | ---------- | -------- | ---------- | ----------------- |
| 0-2     | 弱       | 180-200°     | 40-60%     | 60-80%   | 淺藍粉     | #B0E0E6 → #E0F7FA |
| 3-5     | 中       | 30-50°       | 60-80%     | 65-85%   | 明亮暖色   | #FFD700 → #FFEB3B |
| 6-7     | 強       | 15-35°       | 70-90%     | 60-80%   | 金黃橙     | #FF8C00 → #FFA500 |
| 8-10    | 極強     | 10-25°       | 80-100%    | 50-70%   | 鮮豔橙紅   | #FF6B35 → #FF4500 |
| 11+     | 危險     | 0-15°        | 90-100%    | 40-60%   | 強烈紅橙   | #FF4500 → #DC143C |
| X / -99 | 無效值   | -            | -          | -        | 使用預設值 | 中性色            |

### **4. 降雨量顏色映射**

| 降雨量   | 強度等級 | HSL 色相 (H) | 飽和度 (S) | 明度 (L) | 顏色描述     | 範例顏色          |
| -------- | -------- | ------------ | ---------- | -------- | ------------ | ----------------- |
| < 1mm    | 小雨     | 200-220°     | 50-70%     | 60-80%   | 淺藍         | #87CEEB → #B0E0E6 |
| 1-5mm    | 中雨     | 200-230°     | 60-80%     | 40-60%   | 深藍         | #4682B4 → #5F9EA0 |
| > 5mm    | 大雨     | 210-240°     | 70-90%     | 30-50%   | 墨藍         | #2F4F4F → #4682B4 |
| T (雨跡) | 微量     | 200-210°     | 40-60%     | 70-85%   | 極淺藍       | #E0F7FA → #F0F8FF |
| -98      | 無降水   | -            | -          | -        | 使用天氣類型 | 根據 Weather      |
| X / -99  | 無效值   | -            | -          | -        | 使用預設值   | 中性色            |

### **5. 溫度顏色映射**

| 溫度範圍 | 體感   | HSL 色相 (H) | 飽和度 (S) | 明度 (L) | 顏色描述   | 範例顏色          |
| -------- | ------ | ------------ | ---------- | -------- | ---------- | ----------------- |
| < 10°C   | 冰冷   | 240-270°     | 50-70%     | 40-60%   | 藍紫灰     | #4A5568 → #718096 |
| 10-20°C  | 涼爽   | 180-220°     | 50-70%     | 55-75%   | 藍綠       | #5F9EA0 → #87CEEB |
| 20-25°C  | 舒適   | 120-180°     | 40-60%     | 60-80%   | 自然色     | #90EE90 → #98FB98 |
| 25-30°C  | 溫暖   | 30-60°       | 60-80%     | 65-85%   | 黃橙       | #FFD700 → #FFA500 |
| > 30°C   | 炎熱   | 0-30°        | 70-90%     | 50-70%   | 紅橙       | #FF6B35 → #FF4500 |
| X / -99  | 無效值 | -            | -          | -        | 使用預設值 | 中性色            |

### **6. 綜合顏色計算規則**

#### **基礎色相計算**

```
基礎色相 =
  (時間色相 × 0.4) +
  (天氣色相 × 0.3) +
  (溫度色相 × 0.2) +
  (紫外線/降雨色相 × 0.1)
```

#### **飽和度計算**

```
飽和度 =
  基礎飽和度 ×
  (1 + 濕度影響 × 0.1) ×
  (1 - 雲量影響 × 0.2)
```

#### **明度計算**

```
明度 =
  基礎明度 ×
  (1 - 時間影響 × 0.3) ×
  (1 + 日照影響 × 0.1)
```

#### **特殊情況處理**

- **無效值處理**: 當遇到 `X` 或 `-99` 時，該欄位不參與計算，權重重新分配
- **衝突處理**: 當天氣為"雨"但降雨量為 `-98` 時，優先使用天氣類型
- **邊界處理**: 所有數值需進行邊界檢查，確保在有效範圍內

### **7. 顏色映射範例**

#### **範例 1: 晴朗上午**

- 時間: 10:00 (上午) → H: 40°, S: 80%, L: 70%
- 天氣: "晴" → H: 45°, S: 80%, L: 70%
- UV: 5 (中) → H: 40°, S: 70%, L: 75%
- 溫度: 22°C (舒適) → H: 150°, S: 50%, L: 70%
- **結果**: H: 42°, S: 75%, L: 71% → 明亮暖黃色 (#FFD700)

#### **範例 2: 陰雨下午**

- 時間: 16:00 (下午) → H: 30°, S: 70%, L: 65%
- 天氣: "雨" → H: 220°, S: 60%, L: 40%
- 降雨: 3mm (中雨) → H: 215°, S: 70%, L: 50%
- 溫度: 18°C (涼爽) → H: 200°, S: 60%, L: 65%
- **結果**: H: 165°, S: 65%, L: 55% → 沉穩藍灰色 (#5F9EA0)

#### **範例 3: 炎熱中午**

- 時間: 13:00 (中午) → H: 50°, S: 90%, L: 80%
- 天氣: "晴" → H: 45°, S: 80%, L: 70%
- UV: 8 (極強) → H: 15°, S: 90%, L: 60%
- 溫度: 32°C (炎熱) → H: 15°, S: 80%, L: 60%
- **結果**: H: 30°, S: 85%, L: 68% → 鮮豔橙紅色 (#FF6B35)
